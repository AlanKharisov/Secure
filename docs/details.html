<!doctype html>
<html lang="uk">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Деталі продукту — MARKI Secure</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .detail-card{max-width:860px;margin:24px auto;padding:0 16px}
        .hero{display:flex;flex-wrap:wrap;gap:16px}
        .hero .imgwrap{flex:0 0 320px;background:#0c1330;border-radius:14px;display:grid;place-items:center;border:1px solid var(--border);padding:12px}
        .hero .info{flex:1;border:1px solid var(--border);border-radius:14px;padding:14px;background:linear-gradient(180deg, rgba(19,26,52,.75), rgba(12,17,39,.75))}
        .chip{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--border);margin-right:6px;margin-bottom:6px}
        .prodimg{width:100%;max-height:300px;object-fit:cover;border-radius:10px}
        .sub{color:var(--muted);font-size:13px}
        .kpi{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-top:10px}
        .kpi .card{padding:10px;border-radius:12px}
    </style>
    <script defer src="cart.js"></script>
</head>
<body>
<div class="detail-card">
    <a href="index.html" class="btn">← Назад</a>
    <h1 style="margin:10px 0 6px">Деталі продукту</h1>
    <div class="sub">Швидка перевірка автентичності для покупця</div>

    <div id="content" class="card" style="margin-top:14px">Завантаження…</div>
</div>

<script>
    const API = window.location.origin;
    const $ = (s)=>document.querySelector(s);
    const qs = new URLSearchParams(location.search);
    const id  = qs.get('id');
    const s   = qs.get('s') || "";

    function esc(s){return (s??'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

    async function load(){
        const box = $('#content');
        if(!id){ box.innerHTML = '<div class="result bad">Немає id</div>'; return; }
        try{
            const r = await fetch(`${API}/api/verify/${encodeURIComponent(id)}`);
            const j = await r.json();
            if(!r.ok) throw new Error(j.error || 'Not found');

            let verdict = { cls:'warn', text:'Базова перевірка: знайдено в реєстрі' };
            if (s) verdict = (s === j.serialHash)
                ? { cls:'ok',  text:'Оригінал: QR збігається з реєстром' }
                : { cls:'bad', text:'Можлива підробка: QR не збігається' };

            const chips = (j.metadata.certificates||[]).map(c=>`<span class="chip">${esc(c)}</span>`).join('') || '<span class="muted">немає</span>';
            const img = (j.metadata.image||'').trim()
                ? `<img class="prodimg" src="${esc(j.metadata.image)}" alt="Фото">`
                : `<div class="muted">Немає зображення</div>`;

            const statusExplain =
                j.state==='claimed'   ? 'Справжній: продукт передано власнику.'
                    : j.state==='purchased' ? 'Куплено: продукт знаходиться у покупця.'
                        : j.state==='created'   ? 'Створено: ще не позначено як куплений.'
                            : 'Невідомий стан.';

            // Кнопка додати в кошик (тільки для created)
            const addBtn = (j.state==='created')
                ? `<div style="margin-top:12px">
               <button id="addToCart" class="btn primary">Додати в кошик</button>
             </div>` : ``;

            $('#content').innerHTML = `
          <div class="hero">
            <div class="imgwrap">${img}</div>
            <div class="info">
              <div style="display:flex;gap:10px;align-items:center;justify-content:space-between">
                <h2 style="margin:0">${esc(j.metadata.name)}</h2>
                <span class="badge">${esc(j.state)}</span>
              </div>
              <div class="sub" style="margin-top:4px">${statusExplain}</div>

              <div class="mono" style="margin-top:6px">TokenId: ${esc(String(j.tokenId))}</div>
              <div class="mono">Serial: ${esc(j.metadata.serial)}</div>
              <div>Вироблено: ${esc(j.metadata.manufacturedAt)}</div>
              <div style="margin:10px 0">Сертифікати: ${chips}</div>

              <div class="kpi">
                <div class="card result ${verdict.cls}"><b>Автентичність:</b> ${verdict.text}</div>
                <div class="card">
                  <div><b>Докази</b></div>
                  <div class="mono">SerialHash: ${esc(j.serialHash||'-')}</div>
                  <div class="mono">IPFS (mock): ${esc(j.ipfsHash||'-')}</div>
                </div>
              </div>

              ${addBtn}
            </div>
          </div>`;

            // логіка "Додати в кошик"
            const btn = document.getElementById('addToCart');
            if (btn) {
                btn.addEventListener('click', ()=>{
                    const item = {
                        id: j.tokenId,
                        name: j.metadata.name,
                        serial: j.metadata.serial,
                        serialHash: j.serialHash,
                        image: j.metadata.image || '',
                        url: location.href.split('#')[0]
                    };
                    window.MCart.add(item);
                    btn.textContent = 'Додано ✓';
                    btn.disabled = true;
                    alert('Додано в кошик');
                });
            }
        }catch(e){
            $('#content').innerHTML = `<div class="result bad">Помилка: ${esc(e.message)}</div>`;
        }
    }
    load();
</script>
</body>
</html>